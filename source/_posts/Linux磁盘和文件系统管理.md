---
title: Linux磁盘和文件系统管理
date: 2018-11-22 23:42:09
tags: 课程学习
categories: Linux
---

# Linux磁盘和文件系统管理

在Linux系统中，如果需要在某个磁盘上存储数据，则需要将磁盘进行分区，创建文件系统，最后将文件系统挂载到目录下才可以。为了控制文件和目录的访问，可以设置文件和目录的访问权限，甚至可以更改文件和目录的所有权。

## Linux硬盘分区

### 硬盘分区知识

#### 什么是硬盘分区？

分区就是硬盘的“段落”，如果用户希望在计算机上安装多个操作系统，将需要更多的分区。假设要同时安装Windows XP和Windows 7，那么需要两个分区，原因是不同的操作系统原则上采用不同的文件系统。

#### 分区类型

硬盘分区一共有3种：主分区、扩展分区和逻辑分区。

#### 分区的格式化

不同的操作系统具有不同的硬盘分区工具，Windows系统下非常有名的分区工具是fdisk，在Linux系统下进行分区可以使用fdisk，或者使用相同功能的图形界面程序。每个主分区和逻辑分区都会被存储为一个识别文件系统的附加信息。通过分区当然不能产生任何文件系统。分区必须要进行格式化。

### 使用fdisk进行硬盘分区

Linux系统使用fdsik命令能将磁盘划分成为若干个区，同时也能为每个分区指定分区的文件系统，比如ext3，ext4，FAT 32， SWAP，FAT 16以及其他类UNIX操作系统的文件系统等。

#### fdisk的介绍

使用fdisk命令可以对磁盘进行分区。   
命令语法：   
fdisk [-b <分区大小>][-uv][磁盘设备名]   
fdisk [-l][-b <分区大小>][-uv][磁盘设备名]  
fdisk [-s <分区编号>]

fdisk命令参数  

|子命令|含义|
|---|---|
|m|显示所有在fdisk中使用的命令|
|p|显示硬盘分区信息|
|a|设置硬盘启动区|
|n|创建新的分区|
|e|创建扩展分区|
|p|创建主分区|
|t|更改分区文件系统|
|d|删除硬盘分区|
|q|退出fdisk，不保存硬盘分区设置|
|w|保存硬盘分区设置并退出fdisk|

#### Linux系统下硬盘分区举例

1. 进入fdisk界面，列出所有命令。
2. 显示硬盘分区信息
3. 创建和删除主分区。
4. 创建扩展分区和逻辑驱动器
5. 查看并转换文件系统。
6. 保存分区设置信息，并退出fdisk。
7. 在非交互式界面下显示当前硬盘的分区信息。

## Linux文件系统简介

文件系统通过为每个文件分配文件块的方式把数据存储在存储设备中，这样就要维护每一个文件的文件块的分配信息，而分配信息本身也要存在磁盘上，不同的文件系统用不同的方法分配和读取文件块。

### Linux文件系统的工作原理

有两种常用的文件系统的分配策略：块分配和扩展分配。块分配是当文件变大的时候每一次都为这个文件分配磁盘空间，而扩展分配则是当某个文件的磁盘空间不够的时候，一次性为它分配一连串连续的块。  
传统的UNIX文件系统使用的块分配的机制提供了一个灵活而高效的文件块分配策略。  
可以通过优化文件块的分配策略（尽可能 为文件分配连续的块）来避免文件块的随机分配。   
每一次当文件扩展的时候，块分配的算法就要写入一些关于新分配的块所在位置的信息。

### Linux主流文件系统

文件系统是指文件在硬盘上的存储方法和排列顺序。在Linux系统中，每个分区都是一个文件系统，都有自己的目录层次结构。   
Linux系统最重要特征之一就是支持多种文件系统，这样它更加灵活，并可以和许多其他操作系统共存。   
虚拟文件系统使得Linux可以支持多个不同的文件系统。   
随着Linux系统的不断发展，它所支持的文件格式系统也在迅速扩充。  
下面介绍Linux系统最常用的几种文件系统。  
1. ext3
2. ext4
3. JFS
4. PeiserFS
5. XFS  
其他文件系统：  
1. Minix
2. Xia
3. ISO9660
4. NFS
5. SysV
6. VFAT

## 创建文件系统

如果要加载一个分区，首先需要确认文件系统的类型，然后才能挂载使用，比如通过mount加载或者通过修改/etc/fstab文件开机自动加载都可以实现该功能。

### 创建文件系统简介

对一个新的硬盘进行分区以后，还要对这些分区进行格式化并创建文件系统。一个分区只有建立了某种文件系统后，这个分区才能使用。建立文件系统的过程，就是用相应格式化工具格式化分区的过程，这个过程和在Windows系统中格式化某个分区为NTFS分区的过程类似。  
Linux系统支持目前主流的文件系统，如VFAT，ext3，ext4，ReiserFS，ISO 9660和SWAP交换分区等。如果在计算机上新增加了一 块硬盘，需要格式化成Linux的文件系统，最好选择ext3或ext4文件系统。  
如果需要使用某个文件系统存放数据，一般要经过以下操作步骤。  
1. 使用fdisk命令在硬盘上创建分区。  
2. 使用mkfs命令在分区上创建文件系统。  
3. 使用mount命令挂载文件系统，或修改/etc/fstab文件使得开机自动挂载文件系统。  
4. 使用umount卸载文件系统。

#### 使用mkfs命令创建文件系统

使用mkfs命令可以在分区上建立各种文件系统。   
命令语法：   
mkfs -t [ 文件系统类型 ] [ 磁盘设备名 ]

> // 使用mkfs命令创建文件系统  
// 查看当前磁盘上的分区情况，该磁盘设备是/dev/sda  
fdisk -l /dev/sda  
// 格式化/dev/sda5分区，创建ext4文件系统  
mkfs -t ext4 /dev/sda5  

#### 使用其他命令创建文件系统

> 使用mkfs.ext4命令将/dev/sda5设备格式化成ext4文件系统  
mkfs.ext4 /dev/sda5  

## 挂载和卸载文件系统

使用mount和umount命令可以实现挂载和卸载功能，这样用户才可以使用相应的设备存储数据。

### 挂载文件系统

使用mount命令可以将某个分区、光盘、软盘或是U盘挂载到Linux系统的目录下。  
命令语法：   
mount [ 选项 ] [ 设备名称 ] [ 挂载点 ]  

#### 1. 挂载硬盘

> // 挂载分区/dev/sda5到/mnt/kk目录中  
mount /dev/sda5 /mnt/kk  
// 以只读方式挂载/dev/sda5分区到/mnt/kk目录中  
mount -o ro /dev/sda5 /mnt/kk  

#### 2. 挂载光盘、软盘、u盘  

Linux系统在使用光盘、软盘、U盘以及移动硬盘时，必须先执行挂载命令。挂载命令会将这些存储介质指定成系统中的某个目录，以后直接访问相应目录即可读写存储介质上的数据。  

> // 将光盘放入光驱，挂载光盘到/mnt/cdrom目录中  
mount -t iso9660 /dev/cdrom /mnt/cdrom  
// 将软盘放入软驱，挂载软盘到/mnt/floppy目录中  
mount -t vfat /dev/fd0 /mnt/floppy  
// 创建完u盘挂载目录为/mnt/disk后，将u盘挂载到该目录中  
mount -t vfat /dev/sdb /mnt/disk  


### 卸载文件系统

使用umount命令可以将某个分区、光盘、软盘或是U盘进行卸载。   
命令语法：   
umount [ 选项 ] [ -t <文件系统类型> ] [ 文件系统 ]

#### 1. 卸载硬盘  

> // 卸载分区/dev/sda5文件系统  
umount /dev/sda5  

#### 2. 卸载光盘、软盘、u盘  

> // 卸载光盘  
umount /dev/cdrom  
// 卸载软盘  
umount /dev/fd0  
umount /mnt/floppy  
// 卸载u盘  
umount /mnt/disk  
umount /dev/sdb  

### 查看分区挂载情况

要查看Linux系统分区挂载情况，除了可以使用df命令之外，还可以通过mount –s命令以及查看/etc/mtab文件获取信息。  

#### 1. 使用mount -s命令

> // 使用mount命令查看分区挂载情况  
mount -s  

#### 2. 查看/etc/mtab文件

> // 通过查看/etc/mtab文件查看分区挂载情况  
cat /etc/mtab  

## 设置开机自动挂载文件系统

将某个分区或是设备挂载了以后才能使用，但是当计算机重新启动以后，又需要重新挂载，这个时候可以通过修改/etc/fstab文件实现开 机自动挂载文件系统。  

### /etc/fstab文件简介

/etc/fstab文件是一个配置文件，它包含了所有分区以及存储设备的信息。其中包含了磁盘分区和存储设备如何挂载，以及挂载在什么地方的信息。  
如果在Linux系统中不能访问Windows的分区，或者作为一名普通用户，不能挂载光驱和向软盘中写入数据，或者在管理CD-RW的过程中遇到了问题，就有可能是错误地配置了/etc/fstab文件，通常可以通过编辑 /etc/fstab这个文件来解决前面提到的问题。  
/etc/fstab文件是一个简单的文本文件，可以用任何文本编辑器去编辑它，但是必须要以root用户登录才可以编辑该文件。  

### /etc/fstab文件详解

由于每台计算机系统的分区和设备属性不同，所以/etc/fstab文件也不一样，但是基本的结构总是相似的。下面就是其中的一行：   
/dev/sda5    /mnt/kk    ext4     defaults     0     0   
每1行包含着1个设备或分区的信息，每1行又有多个列的信息。第1列是设备名或者设备UUID号，第2列是它的挂载点，第3列是它的文件系统格式，第4列是挂载参数，第5列是转储选项，第6列是文件系统检查选项。
1. 设备  
使用设备名称或设备UUID号表示都可以。如果要查看某设备的UUID号，可以用下面命令：   
ls –l /dev/disk/by-uuid 或 blkid   
2. 挂载点  
Linux系统为每个设备或分区设定了挂载目录。   
3. 文件系统格式  
Linux系统为每个设备或分区指定了文件系统格式。
4. 挂载参数  
（1）auto和noauto   
（2）user和nouser   
（3）exec和noexec   
（4）ro   
（5）rw   
（6）sync和async   
（7）defaults  
5. 转储选项  
dump选项检查文件系统并用一个数字来决定该文件系统是否需要备份。如果它是0，dump将会忽略该文件系统，不做备份。   
6. 文件系统检查选项  
fsck选项通过检验第6项中的数字来决定以何种顺序检查文件系统，如果它是0，fsck将不检查该文件系统。根文件系统（“/”）的默认值为1，其他文件系统可以为2-9。  

## 使用交换空间

Linux系统中的交换空间在物理内存被用完时使用。如果系统需要更多的内存资源，而物理内存已经用完，内存中不活跃的页就会被转移到交换空间中。虽然交换空间可以为具有少量内存的计算机提供帮助，但是这种方法不应该被当作是对内存的取代。交换空间位于硬盘驱动器上，它比进入物理内存要慢。  

### 添加交换空间

有时，用户需要在安装Linux系统后添加更多的交换空间。用户可以添加一个交换分区或添加一个交换文件，推荐使用添加一个交换分区。交换空间可以是一个专用的交换分区， 也可以是一个交换文件，或是两者的结合。交换空间总的大小至少为计算机内存的1～2倍。  

#### 1. 添加交换分区  

##### 1. 创建交换分区

使用fdisk命令已经创建好/dev/sda5分区，假设将分区/dev/sda5创建为交换（SWAP）分区，在Shell提示下以root用户身份输入以下命令  

> mkswap /dev/sda5  

##### 2. 启用交换分区

输入以下命令启用交换分区/dev/sda5  

> swapon /dev/sda5

##### 3. 确认已经启用交换分区

创建并启用了交换分区之后，使用如下命令查看交换分区是否已经启用。  

> cat /proc/swaps  

##### 4. 如果要在系统引导时启用交换分区，编辑/etc/fstab文件添加如下内容。然后在系统下次引导时，就会启用新建的交换分区  

> /dev/sda5 swap  swap  defaults  0  0

#### 添加交换文件

##### 1. 创建文件/swapfile  

将大小乘以1024来判定块的大小。例如，大小为68MB的交换文件的块大小为65536。  
在Shell提示下以root用户身份输入以下命令，其中的count等于想要输入的块大小。  

> dd if=/dev/zero of=/swapfile bs=1024 count=66536

##### 2. 创建交换文件  

使用以下命令创建交换文件：  
> mkswap /swapfile  

##### 3. 启用交换文件  

使用如下命令启用交换文件：  
> swapon /swapfile  

##### 4. 新添了交换分区并启用它之后，使用如下命令确保交换文件已被启用了  

> cat /proc/swaps  

##### 5. 如果要在系统引导时启用交换文件，编辑/etc/fstab文件添加如下内容。然后在系统下次引导时，就会启用新建的交换文件  

> /swapfile   swap   swap   defaults   0   0

### 删除交换空间  

当某个交换分区或交换文件不再需要时，可以使用如下步骤将其删除。  
#### 删除交换分区

##### 1. 在Shell提示下以root用户身份输入以下命令禁用交换分区（这里的/dev/sdb5是交换分区）  

> swapoff /dev/sda5  

##### 2. 如果要在系统引导时不启用交换分区，编辑/etc/fstab文件删除如下内容。然后在系统下次引导时，就不会启用交换分区  

> /dev/sda5  swap  swap  defaults  0  0

#### 删除交换文件  

##### 1. 在Shell提示下以root用户身份执行以下命令来禁用交换文件（这里的/swapfile是交换文件）  

> swapoff /swapfile

##### 2. 删除/swapfile文件  

输入以下命令删除/swapfile文件：  

> rm -rf /swapfile  

##### 3. 如果要在系统引导时不启用交换文件，编辑/etc/fstab文件删除如下内容。然后在系统下次引导时，就不会启用交换文件  

> /swapfile  swap   swap   defaults   0   0


## 权限设置

### 文件和目录权限  

在Linux系统中，用户可以对每一个文件或目录都具有访问权限，这些访问权限决定了谁能访问，以及如何访问这些文件和目录。

#### 文件权限简介

通过设定权限可以限制或允许以下3种用户访问：文件的所有者（文件属主）、文件所有者所在组的同组用户（同组用户）、系统中的其他用户。   
在Linux系统中，每种用户都有对文件或目录的读取、写入和执行权限。

Linux中，每种用户都有三种权限：  
|权限|对文件的影响|对目录的影响|
|---|---|---|
|r（读取）|可读取文件内容|可浏览目录|
|w（写入）|可修改文件内容|可删除、移动目录内文件|
|x（执行）|可执行文件|可进入目录|

目录必须拥有x权限，否则无法进入目录。  

#### 一般权限

用“ls -l”命令可以显示文件的详细信息，其中包括权限，如下所示：  
> ls -l /root  

表9-2 文件类型  
|代表字符|文件类型|
|---|---|
|d|表示目录文件，目录是一个特殊的文件|
|-|表示普通文件|
|l|表示链接文件，实际上它指向另一个文件|
|b|表示块设备文件|
|c|表示字符设备文件|
|p|表示管道文件|

#### 特殊权限

除了一般权限以外，还有所谓的特殊权限。用户若无特殊需求，不要启用这些权限，避免出现安全漏洞。  

|权限|对文件的影响|对目录的影响|
|---|---|---|
|SUID|以文件的所属用户身份执行，而非执行文件的用户|无|
|SGID|以文件所属组身份执行|在该目录中创建的任意新文件的所属组与该目录的所属组相同|
|Sticky|无|对目录拥有写入权限的用户仅可以删除其拥有的文件，无法删除其他用户所属的文件|

### 权限设置

只有系统管理员和文件的所有者才可以更改文件或目录的权限，更改文件或目录权限的方法一般有3种：  

#### 1. 文件管理器更改权限

#### 2. 文字设定法

通过文字设定法更改权限需要使用chmod命令，格式如下：  
chmod [ugoa][+-=][rwx][文件或目录名]  
u表示该文件的所有者，g表示与该文件的所有者属于同一个组的用户，o表示其他用户，a表示以上三者；  
+表示增加指定权限，-表示取消指定权限，=表示设定权限等于指定权限；  
r表示读取，w表示可写入，x表示表示文件可执行或目录可进入。  
  
通过文字设定法更改特殊权限需要使用chmod命令，chmod命令格式如下：  
|权限|命令|模式|
|---|---|---|
|SUID|chmod u+s|s=x+SUID<br>S=-+SUID|
|SGID|chmod g+s|s=x+SGID<br>S=-+SGID|
|Sticky|chmod o+t|t=x+Sticky<br>T=-+Sticky|

> // 添加所有者对a文件的写入权限  
chmod u+x a  
// 取消所有者对a文件的读取权限  
chmod u-r a  
// 重新分配同组用户对a文件有写入的权限  
chmod g=w a  
// 更改a文件权限，添加所有者为读取、写入权限，同组用户为读取权限，其他用户读取、写入和执行的权限  
chmod u+rw,g+r,o+rwx a  
// 取消所有用户的读取、写入和执行权限  
chmod a-rwx a  
// 添加a文件的特殊权限为SUID  
chmod u+s a  
// 添加a文件的特殊权限为SGID  
chmod g+s a  
// 添加a文件的特殊权限为Sticky  
chmod o+t a  

#### 3. 数字设定法  

文件和目录的权限表中用r，w及x这3个字符来为所有者、同组用户和其他用户设置权限。有时候，字符似乎过于麻烦，因此还有另外一种方法是以数字来表示权限，而且仅需3个数字。  
使用数字设定法更改文件权限，首先必须了解数字表示的含义：0表示没有权限，1表示可执行权限，2表示写入权限，4表示读取权限，然后将其相加。所以数字属性的格式应为3个0～7的8进制数，其顺序是（u），（g），（o）。  
1. r：对应数值4。
2. w：对应数值2。
3. x：对应数值1。
4. -：对应数值0。  
使用数字设定法更改文件权限，chmod的命令格式如下：  
chmod [n1n2n3] [文件或目录名]  

> // 设置a文件权限，所有者拥有读取、写入和执行的权限。  
chmod 700 a  
// 设置a文件权限，所有着拥有读取，同组用户有读取、写入和执行的权限  
chmod 470 a  
// 设置a文件权限，所有用户拥有读取、写入和执行的权限  
chmod 777 a  
// 设置a文件权限，其他用户拥有读取、写入和执行的权限  
chmod 7 a  

如果要加上特殊权限，就必须使用4位数字才能表示。特殊权限的对应数值如下：  
1. SUID：对应数值为4
2. SGID：对应数值为2
3. Sticky：对应数值1

> // 设置文件a具有SUID权限  
chmod 4000 a  
// 设置文件a具有SGID权限  
chmod 2000 a  
// 设置文件a具有Sticky权限  
chmod 1000 a  
// 设置文件a具有SUID，SGID和Sticky权限  
chmod 7000 a  
// 设置/home/user目录连同他的子文件夹的权限为777  
chmod -R 777 /home/user  

### 更改文件和目录的所有权

文件和目录的创建者默认就具有所有权，他们对该文件和目录具有任何权限，可以进行任何操作。他们也可以将所有权交给别的用户，使别的用户对该文件和目录具有任何操作权限。文件和目录的所有者及所属用户组也能修改，用户可以通过图形界面来设置，也可以通过其他命令来修改。

#### 1. chown命令

使用chown命令可以更改文件和目录的所有者和用户组。  
命令语法：  
chown [-R][用户.组][文件|目录]  

> // 将文件a的所有者改成newuser  
chown newuser a  
// 将文件a的用户组改成newuser  
chown :newuser a  
// 将文件a的用户组改成newuser  
chown .newuser a  
// 将目录/root/b连同它的下级文件/root/b/ccc的所有者和用户组一起更改为newuser  
chown -R newuser.newuser /root/b  

#### 2. chgrp命令  

使用chgrp命令可以更改文件或目录所属的组。  
命令语法：  
chgrp [选项][用户组][文件|目录]  

> // 更改文件a的用户组为newuser  
chgrp newuser a  
